{% extends "base.html" %}

{% block extra_css %}
<style>
    .quiz-header {
        background-color: #212529;
        color: #fff;
        padding: 15px 20px;
        border-bottom: 3px solid #0d6efd;
        position: sticky;
        top: 0;
        z-index: 100;
    }
    
    .timer-display {
        background-color: #495057;
        padding: 8px 15px;
        border: 2px solid #0d6efd;
        font-size: 18px;
        font-weight: bold;
        min-width: 120px;
        text-align: center;
        border-radius: 0.375rem;
    }
    
    .timer-display.warning {
        background-color: #dc3545;
        border-color: #b02a37;
        animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    .question-nav-btn {
        padding: 8px;
        border: 1px solid #dee2e6;
        background-color: #fff;
        cursor: pointer;
        font-size: 13px;
        font-weight: bold;
        text-align: center;
        transition: all 0.2s;
        border-radius: 0.375rem;
    }
    
    .question-nav-btn:hover {
        background-color: #f8f9fa;
    }
    
    .question-nav-btn.current {
        background-color: #0d6efd;
        color: #fff;
        border-color: #0a58ca;
    }
    
    .question-nav-btn.answered {
        background-color: #198754;
        color: #fff;
        border-color: #146c43;
    }
    
    .question-nav-btn.unanswered {
        background-color: #fff;
        color: #6c757d;
    }
    
    .option-item {
        background-color: #fff;
        border: 2px solid #dee2e6;
        padding: 15px;
        margin: 10px 0;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 12px;
        user-select: none;
        border-radius: 0.375rem;
    }
    
    .option-item:hover {
        background-color: #f8f9fa;
        border-color: #0d6efd;
        transform: translateX(5px);
    }
    
    .option-item.selected {
        background-color: #e7f1ff;
        border-color: #0d6efd;
        border-width: 2px;
    }
    
    .option-item input[type="radio"],
    .option-item input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        flex-shrink: 0;
    }
    
    .option-item input[type="radio"]:checked ~ label,
    .option-item input[type="checkbox"]:checked ~ label {
        font-weight: bold;
        color: #212529;
    }
    
    .option-item input[type="radio"]:checked,
    .option-item input[type="checkbox"]:checked {
        accent-color: #0d6efd;
    }
    
    .option-item label {
        cursor: pointer;
        flex: 1;
        margin: 0;
        font-size: 15px;
        line-height: 1.6;
    }
    
        .answer-textarea {
        width: 100%;
        padding: 15px;
        border: 2px solid #dee2e6;
        font-size: 15px;
        font-family: inherit;
        min-height: 120px;
        resize: vertical;
    }
    
    /* Question container visibility */
    .question-container {
        display: none;
    }
    
    .question-container.active {
        display: block;
    }
    
    #submitSection {
        display: none;
    }
    
    #submitSection.active {
        display: block;
    }
    
    .answer-textarea:focus {
        border-color: #0d6efd;
        outline: none;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
</style>
{% endblock %}

{% block content %}
<!-- Alert Modal -->
<div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" id="alertModalHeader">
                <h5 class="modal-title" id="alertModalLabel">Alert</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="alertModalBody">
                Alert message
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="alertModalBtn" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="confirmModalLabel">Confirm Submission</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                Are you sure you want to submit?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmSubmitBtn">Submit</button>
            </div>
        </div>
    </div>
</div>

<!-- Focus Warning Modal -->
<div class="modal fade" id="focusWarningModal" tabindex="-1" aria-labelledby="focusWarningModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="focusWarningModalLabel">Focus Warning</h5>
            </div>
            <div class="modal-body" id="focusWarningModalBody">
                Warning message
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="focusWarningBtn">Continue Quiz</button>
            </div>
        </div>
    </div>
</div>

<!-- Fullscreen Prompt Modal -->
<div class="modal fade" id="fullscreenModal" tabindex="-1" aria-labelledby="fullscreenModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info">
                <h5 class="modal-title" id="fullscreenModalLabel">Fullscreen Mode</h5>
            </div>
            <div class="modal-body">
                For the best quiz experience, please click OK to enter fullscreen mode. This helps minimize distractions.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="fullscreenBtn">Enter Fullscreen</button>
            </div>
        </div>
    </div>
</div>

<!-- Quiz Header -->
<div class="quiz-header">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div class="quiz-header-title">
                <h1 class="h4 mb-0 text-white">{{ quiz.title }}</h1>
            </div>
            <div class="d-flex align-items-center gap-3 flex-wrap">
                <div class="d-flex align-items-center gap-2 text-light">
                    <strong class="text-info">Questions:</strong> <span>{{ questions|length }}</span>
                </div>
                <div class="d-flex align-items-center gap-2 text-light">
                    <strong class="text-info">Marks:</strong> <span>{{ quiz.get_total_marks }}</span>
                </div>
                <div class="timer-display" id="timer">
                    <span id="timeLeft">Loading...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Quiz Container -->
<div class="container-fluid my-4">
    <div class="row g-4">
        <!-- Question Navigator Sidebar -->
        <div class="col-xl-3 col-lg-4">
            <div class="position-sticky" style="top: 100px;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="mb-0">Question Navigator</h2>
                    </div>
                    <div class="card-body">
                        <div class="row g-2 mb-3" id="questionNavGrid">
                            {% for question in questions %}
                            <div class="col-3">
                                <button type="button" class="question-nav-btn w-100" data-question="{{ forloop.counter }}" data-action="goToQuestion">
                                    {{ forloop.counter }}
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="border-top pt-3">
                            <small class="text-muted">
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <div class="bg-primary" style="width: 20px; height: 20px; border-radius: 0.375rem;"></div>
                                    <span>Current</span>
                                </div>
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <div class="bg-success" style="width: 20px; height: 20px; border-radius: 0.375rem;"></div>
                                    <span>Answered</span>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="bg-light border" style="width: 20px; height: 20px; border-radius: 0.375rem;"></div>
                                    <span>Not Answered</span>
                                </div>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Questions Area -->
        <div class="col-xl-9 col-lg-8">
            <form method="post" id="quizForm">
                {% csrf_token %}
                
                {% for question in questions %}
                <div class="question-container" data-question="{{ forloop.counter }}">
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3 pb-3 border-bottom border-primary">
                                <div>
                                    <h3 class="fw-bold mb-1">
                                        Question {{ forloop.counter }}
                                        {% if question.is_required %}
                                        <span class="text-danger small">* Required</span>
                                        {% endif %}
                                    </h3>
                                </div>
                                <span class="badge bg-primary">{{ question.marks }} marks</span>
                            </div>
                            
                            <div class="alert alert-light border-start border-primary border-3 mb-4">
                                {{ question.question_text|safe }}
                            </div>
                            
                            {% if question.question_type == 'single' or question.question_type == 'true_false' %}
                                <div class="alert alert-info py-2 mb-3">
                                    <small><em>Select one answer</em></small>
                                </div>
                                <div class="options-container">
                                    {% for option in question.options.all %}
                                    <div class="option-item">
                                        <input type="radio" name="question_{{ question.id }}" 
                                               id="opt_{{ option.id }}" value="{{ option.id }}"
                                               {% if question.is_required %}required{% endif %}
                                               data-question-num="{{ forloop.parentloop.counter }}">
                                        <label for="opt_{{ option.id }}">{{ option.option_text }}</label>
                                    </div>
                                    {% endfor %}
                                </div>
                            
                            {% elif question.question_type == 'multiple' %}
                                <div class="alert alert-info py-2 mb-3">
                                    <small><em>Select all that apply</em></small>
                                </div>
                                <div class="options-container">
                                    {% for option in question.options.all %}
                                    <div class="option-item">
                                        <input type="checkbox" name="question_{{ question.id }}" 
                                               id="opt_{{ option.id }}" value="{{ option.id }}"
                                               data-question-num="{{ forloop.parentloop.counter }}">
                                        <label for="opt_{{ option.id }}">{{ option.option_text }}</label>
                                    </div>
                                    {% endfor %}
                                </div>
                            
                            {% elif question.question_type == 'short_answer' %}
                                <div class="alert alert-info py-2 mb-3">
                                    <small><em>Type your answer below</em></small>
                                </div>
                                <div class="options-container">
                                    <textarea name="question_{{ question.id }}" class="answer-textarea form-control"
                                              placeholder="Enter your answer here..."
                                              {% if question.is_required %}required{% endif %}
                                              data-question-num="{{ forloop.counter }}"></textarea>
                                </div>
                            {% endif %}
                            
                            <div class="d-flex justify-content-between gap-3 mt-4 pt-3 border-top">
                                <button type="button" class="btn btn-outline-secondary nav-prev-btn">
                                    ← Previous
                                </button>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary nav-next-btn">
                                        Next →
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                <!-- Submit Section -->
                <div class="submit-section" id="submitSection">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="alert alert-light mb-4">
                                <h2 class="alert-heading">Review Your Answers</h2>
                                <div class="row text-center my-4">
                                    <div class="col-md-4">
                                        <h3 class="text-primary" id="totalQuestions">{{ questions|length }}</h3>
                                        <small class="text-muted">Total Questions</small>
                                    </div>
                                    <div class="col-md-4">
                                        <h3 class="text-success" id="answeredTotal">0</h3>
                                        <small class="text-muted">Answered</small>
                                    </div>
                                    <div class="col-md-4">
                                        <h3 class="text-warning" id="unansweredTotal">{{ questions|length }}</h3>
                                        <small class="text-muted">Not Answered</small>
                                    </div>
                                </div>
                                <p class="text-muted mb-0">
                                    Please review your answers before submitting. You can navigate back to any question using the question navigator.
                                </p>
                            </div>
                            <button type="button" class="btn btn-success btn-lg mb-3" id="finalSubmitBtn">
                                Submit Quiz
                            </button>
                            <br>
                            <button type="button" class="btn btn-outline-secondary" data-action="goToQuestion" data-question="{{ questions|length }}">
                                ← Back to Questions
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let currentQuestionNum = 1;
const totalQuestions = {{ questions|length }};
const answeredQuestions = new Set();

// Bootstrap Modal instances
let alertModal, confirmModal, focusWarningModal, fullscreenModal;

// Modal Functions
function showAlert(message, type = 'info', title = 'Notice') {
    document.getElementById('alertModalLabel').textContent = title;
    document.getElementById('alertModalBody').innerHTML = message;
    
    const icon = type === 'warning' ? '⚠️' : type === 'error' ? '❌' : type === 'success' ? '✅' : 'ℹ️';
    document.getElementById('alertModalLabel').innerHTML = `${icon} ${title}`;
    
    alertModal.show();
    
    return new Promise((resolve) => {
        document.getElementById('alertModalBtn').onclick = function() {
            alertModal.hide();
            resolve(true);
        };
    });
}

function showConfirm(message, title = 'Confirm') {
    document.getElementById('confirmModalLabel').textContent = title;
    document.getElementById('confirmModalBody').innerHTML = message;
    
    confirmModal.show();
    
    return new Promise((resolve) => {
        const handleCancel = () => {
            confirmModal.hide();
            resolve(false);
        };
        
        const handleConfirm = () => {
            confirmModal.hide();
            resolve(true);
        };
        
        // Remove any existing event listeners
        const cancelBtn = document.querySelector('#confirmModal .btn-secondary');
        const confirmBtn = document.getElementById('confirmSubmitBtn');
        
        cancelBtn.onclick = handleCancel;
        confirmBtn.onclick = handleConfirm;
        
        // Also handle modal close events
        document.getElementById('confirmModal').addEventListener('hidden.bs.modal', handleCancel, { once: true });
    });
}

function showFullscreenPrompt() {
    fullscreenModal.show();
    
    document.getElementById('fullscreenBtn').onclick = function() {
        fullscreenModal.hide();
        enterFullscreen();
    };
}

// Get CSRF token for AJAX requests
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// Timer - Backend Managed
let timeLeft = {{ time_remaining_seconds }};
const timerEl = document.getElementById('timeLeft');
const timerDisplay = document.getElementById('timer');
const attemptId = {{ attempt.id }};
const checkTimeUrl = "{% url 'check_quiz_time' attempt.id %}";

// Sync with backend every 10 seconds
function syncTimeWithBackend() {
    fetch(checkTimeUrl)
        .then(response => response.json())
        .then(data => {
            if (data.expired || data.completed) {
                showAlert(
                    'Time is up! Your quiz will be submitted automatically.',
                    'danger',
                    'Time Expired'
                ).then(() => {
                    document.getElementById('quizForm').submit();
                });
            } else {
                timeLeft = data.time_remaining;
            }
        })
        .catch(error => {
            console.error('Error syncing time with backend:', error);
        });
}

setInterval(syncTimeWithBackend, 10000);

function updateTimer() {
    const mins = Math.floor(timeLeft / 60);
    const secs = timeLeft % 60;
    timerEl.textContent = mins + ':' + (secs < 10 ? '0' : '') + secs;
    
    if (timeLeft <= 60) {
        timerDisplay.classList.add('warning');
    }
    
    if (timeLeft <= 0) {
        showAlert(
            'Time is up! Your quiz will be submitted automatically.',
            'danger',
            'Time Expired'
        ).then(() => {
            document.getElementById('quizForm').submit();
        });
        return;
    }
    
    timeLeft--;
}

setInterval(updateTimer, 1000);
updateTimer();

// Handle form submission
document.getElementById('finalSubmitBtn').addEventListener('click', async function() {
    const confirmed = await showConfirm(
        'Are you sure you want to submit your quiz?<br><br><strong>Important:</strong> You cannot change your answers after submission.',
        'Confirm Submission'
    );
    
    if (confirmed) {
        this.disabled = true;
        this.textContent = 'Submitting...';
        document.getElementById('quizForm').submit();
    }
});

// Question Navigation
function showQuestion(questionNum) {
    // Hide all questions and submit section
    document.querySelectorAll('.question-container').forEach(q => q.classList.remove('active'));
    document.getElementById('submitSection').classList.remove('active');
    
    const questionToShow = document.querySelector(`.question-container[data-question="${questionNum}"]`);
    if (questionToShow) {
        questionToShow.classList.add('active');
        currentQuestionNum = questionNum;
        updateNavButtons();
        updateNavigator();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function goToQuestion(questionNum) {
    if (questionNum >= 1 && questionNum <= totalQuestions) {
        showQuestion(questionNum);
    } else if (questionNum > totalQuestions) {
        showSubmitSection();
    }
}

function nextQuestion() {
    if (currentQuestionNum < totalQuestions) {
        goToQuestion(currentQuestionNum + 1);
    } else {
        showSubmitSection();
    }
}

function previousQuestion() {
    if (currentQuestionNum > 1) {
        goToQuestion(currentQuestionNum - 1);
    }
}

function showSubmitSection() {
    document.querySelectorAll('.question-container').forEach(q => q.classList.remove('active'));
    document.getElementById('submitSection').classList.add('active');
    
    document.getElementById('answeredTotal').textContent = answeredQuestions.size;
    document.getElementById('unansweredTotal').textContent = totalQuestions - answeredQuestions.size;
    
    document.querySelectorAll('.question-nav-btn').forEach(btn => btn.classList.remove('current'));
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function updateNavButtons() {
    const activeQuestion = document.querySelector('.question-container.active');
    if (!activeQuestion) return;
    
    const prevBtn = activeQuestion.querySelector('.nav-prev-btn');
    const nextBtn = activeQuestion.querySelector('.nav-next-btn');
    
    if (prevBtn) {
        prevBtn.disabled = currentQuestionNum === 1;
    }
    
    if (nextBtn) {
        nextBtn.textContent = currentQuestionNum === totalQuestions ? 'Review & Submit →' : 'Next →';
    }
}

function updateNavigator() {
    document.querySelectorAll('.question-nav-btn').forEach(btn => {
        const qNum = parseInt(btn.dataset.question);
        btn.classList.remove('current', 'answered', 'unanswered');
        
        if (qNum === currentQuestionNum) {
            btn.classList.add('current');
        } else if (answeredQuestions.has(qNum)) {
            btn.classList.add('answered');
        } else {
            btn.classList.add('unanswered');
        }
    });
}

function markAnswered(questionNum) {
    answeredQuestions.add(questionNum);
    updateNavigator();
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    // Initialize modals
    alertModal = new bootstrap.Modal(document.getElementById('alertModal'));
    confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    focusWarningModal = new bootstrap.Modal(document.getElementById('focusWarningModal'));
    fullscreenModal = new bootstrap.Modal(document.getElementById('fullscreenModal'));
    
    // Initialize first question
    showQuestion(1);
    
    // Fullscreen button click handler
    document.getElementById('fullscreenBtn').addEventListener('click', function() {
        fullscreenModal.hide();
        enterFullscreen();
    });
    
    // Show fullscreen prompt after everything is initialized
    showFullscreenPrompt();
    
    // Initialize focus tracking
    lastFocusTime = Date.now();
    
    // Navigation button event listeners
    document.addEventListener('click', function(e) {
        // Handle navigation buttons
        if (e.target.classList.contains('nav-prev-btn')) {
            previousQuestion();
        } else if (e.target.classList.contains('nav-next-btn')) {
            nextQuestion();
        }
        
        // Handle question navigator buttons
        if (e.target.dataset.action === 'goToQuestion') {
            const questionNum = parseInt(e.target.dataset.question);
            goToQuestion(questionNum);
        }
        
        // Handle option clicks
        const optionItem = e.target.closest('.option-item');
        if (optionItem) {
            const input = optionItem.querySelector('input[type="radio"], input[type="checkbox"]');
            const label = optionItem.querySelector('label');
            
            if (input && e.target !== input && e.target !== label) {
                if (input.type === 'radio') {
                    input.checked = true;
                    input.dispatchEvent(new Event('change'));
                } else if (input.type === 'checkbox') {
                    input.checked = !input.checked;
                    input.dispatchEvent(new Event('change'));
                }
            }
        }
    });
    
    // Form input change listeners
    document.addEventListener('change', function(e) {
        if (e.target.matches('input[type="radio"], input[type="checkbox"]')) {
            const questionNum = parseInt(e.target.dataset.questionNum);
            if (questionNum) {
                markAnswered(questionNum);
            }
            
            // Update visual feedback
            if (e.target.type === 'radio') {
                const name = e.target.name;
                document.querySelectorAll(`input[name="${name}"]`).forEach(radio => {
                    radio.closest('.option-item').classList.remove('selected');
                });
            }
            updateOptionStyles();
        }
    });
    
    // Textarea input listeners
    document.addEventListener('input', function(e) {
        if (e.target.matches('textarea[data-question-num]')) {
            const questionNum = parseInt(e.target.dataset.questionNum);
            if (questionNum) {
                markAnswered(questionNum);
            }
        }
    });
    
    // Show fullscreen prompt
    showFullscreenPrompt();
});

// Update option visual styles
function updateOptionStyles() {
    document.querySelectorAll('.option-item').forEach(item => {
        const input = item.querySelector('input[type="radio"], input[type="checkbox"]');
        if (input && input.checked) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }
    });
}

// Fullscreen functions
function showFullscreenPrompt() {
    if (fullscreenModal) {
        fullscreenModal.show();
    }
}

// Focus warning modal function
function showFocusWarning(message) {
    return new Promise((resolve) => {
        if (focusWarningModal) {
            // Set the message in the modal body
            document.getElementById('focusWarningModalBody').innerHTML = message;
            
            // Set up the button click handler
            const button = document.getElementById('focusWarningBtn');
            const handleClick = () => {
                button.removeEventListener('click', handleClick);
                focusWarningModal.hide();
                resolve();
            };
            
            button.addEventListener('click', handleClick);
            focusWarningModal.show();
        } else {
            resolve();
        }
    });
}

// Fullscreen functionality
function enterFullscreen() {
    const elem = document.documentElement;
    if (elem.requestFullscreen) {
        elem.requestFullscreen().catch(err => {
            console.log('Fullscreen request failed:', err);
        });
    } else if (elem.webkitRequestFullscreen) {
        elem.webkitRequestFullscreen();
    } else if (elem.msRequestFullscreen) {
        elem.msRequestFullscreen();
    }
}

// Monitor fullscreen changes
document.addEventListener('fullscreenchange', function() {
    if (!document.fullscreenElement) {
        showAlert(
            'You have exited fullscreen mode. Please click OK to return to fullscreen and continue the quiz.',
            'warning',
            'Fullscreen Required'
        ).then(() => {
            enterFullscreen();
        });
    }
});

document.addEventListener('webkitfullscreenchange', function() {
    if (!document.webkitFullscreenElement) {
        showAlert(
            'You have exited fullscreen mode. Please click OK to return to fullscreen and continue the quiz.',
            'warning',
            'Fullscreen Required'
        ).then(() => {
            enterFullscreen();
        });
    }
});

// Focus/Blur tracking
let focusWarningCount = 0;
const MAX_WARNINGS = 3;
let isProcessingWarning = false;
let lastFocusTime = Date.now();

async function handleFocusLoss(reason) {
    if (isProcessingWarning) {
        return;
    }
    
    // Only warn if user was away for more than 1 second
    const timeSinceFocus = Date.now() - lastFocusTime;
    if (timeSinceFocus < 1000) {
        return;
    }
    
    isProcessingWarning = true;
    focusWarningCount++;
    
    if (focusWarningCount >= MAX_WARNINGS) {
        await showFocusWarning(
            `<strong>Final Warning #${focusWarningCount}</strong><br><br>` +
            'You have reached the maximum number of warnings. Your quiz will be automatically submitted now to prevent cheating.'
        );
        
        // Auto-submit the quiz
        const quizForm = document.getElementById('quizForm');
        if (quizForm) {
            // Add a hidden field to indicate auto-submission due to violations
            const autoSubmitField = document.createElement('input');
            autoSubmitField.type = 'hidden';
            autoSubmitField.name = 'auto_submit_reason';
            autoSubmitField.value = 'focus_violations';
            quizForm.appendChild(autoSubmitField);
            
            // Submit the form
            quizForm.submit();
        } else {
            // Fallback: reload the page if form not found
            window.location.reload();
        }
    } else {
        const remainingWarnings = MAX_WARNINGS - focusWarningCount;
        await showFocusWarning(
            `<strong>Warning #${focusWarningCount} of ${MAX_WARNINGS}</strong><br><br>` +
            `${reason}<br><br>` +
            `You have <strong>${remainingWarnings}</strong> warning${remainingWarnings > 1 ? 's' : ''} remaining before your quiz is automatically submitted.`
        );
    }
    
    isProcessingWarning = false;
}

document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        lastFocusTime = Date.now();
        // Don't immediately show warning, wait for user to return
        setTimeout(() => {
            if (document.hidden) {
                handleFocusLoss('You switched to another tab or minimized the browser. Please stay focused on the quiz.');
            }
        }, 1000); // Wait 1 second before showing warning
    } else {
        // User returned, update last focus time
        lastFocusTime = Date.now();
    }
});

// Window blur/focus tracking
window.addEventListener('blur', function() {
    lastFocusTime = Date.now();
    // Don't immediately show warning, wait to see if it's just a brief focus loss
    setTimeout(() => {
        if (document.hasFocus && !document.hasFocus()) {
            handleFocusLoss('You clicked outside the quiz window or switched applications. Please stay focused on the quiz.');
        }
    }, 1000); // Wait 1 second before showing warning
});

window.addEventListener('focus', function() {
    // User returned focus, update time and reset processing flag
    lastFocusTime = Date.now();
    isProcessingWarning = false;
});

// Prevent leaving the page
window.addEventListener('beforeunload', function(e) {
    e.preventDefault();
    e.returnValue = 'Are you sure you want to leave? Your quiz progress may be lost.';
    return 'Are you sure you want to leave? Your quiz progress may be lost.';
});

// Prevent context menu and certain shortcuts
document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    showAlert(
        'Right-click is disabled during the quiz. The page will refresh.',
        'warning',
        'Action Not Allowed'
    ).then(() => {
        window.location.reload();
    });
});

document.addEventListener('keydown', function(e) {
    if (e.keyCode === 123 || 
        (e.ctrlKey && e.shiftKey && e.keyCode === 73) || 
        (e.ctrlKey && e.shiftKey && e.keyCode === 74) || 
        (e.ctrlKey && e.keyCode === 85)) {
        e.preventDefault();
        showAlert(
            'This action is not allowed during the quiz. The page will refresh.',
            'warning',
            'Action Not Allowed'
        ).then(() => {
            window.location.reload();
        });
    }
});
</script>
{% endblock %}
