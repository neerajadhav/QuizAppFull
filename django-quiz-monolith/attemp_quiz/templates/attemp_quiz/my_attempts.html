{% extends "base.html" %}
{% load static %}

{% block title %}My Quiz Attempts{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-history me-2"></i>
                        My Quiz Attempts
                    </h4>
                </div>
                <div class="card-body">
                    {% if attempts %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Quiz Title</th>
                                        <th>Status</th>
                                        <th>Score</th>
                                        <th>Started</th>
                                        <th>Completed</th>
                                        <th>Time Taken</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for attempt in attempts %}
                                        <tr>
                                            <td>
                                                <div>
                                                    <strong>{{ attempt.quiz.title }}</strong>
                                                    <br>
                                                    <small class="text-muted">
                                                        {{ attempt.quiz.get_intent_degree_display }} - 
                                                        Semester {{ attempt.quiz.intent_semester }}
                                                    </small>
                                                </div>
                                            </td>
                                            <td>
                                                {% if attempt.status == 'completed' %}
                                                    <span class="badge bg-success">Completed</span>
                                                {% elif attempt.status == 'in_progress' %}
                                                    <span class="badge bg-warning">In Progress</span>
                                                {% elif attempt.status == 'started' %}
                                                    <span class="badge bg-info">Started</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ attempt.get_status_display }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if attempt.score %}
                                                    <div>
                                                        <strong class="
                                                            {% if attempt.score >= 80 %}text-success
                                                            {% elif attempt.score >= 60 %}text-warning
                                                            {% else %}text-danger{% endif %}">
                                                            {{ attempt.score|floatformat:1 }}%
                                                        </strong>
                                                        <br>
                                                        <small class="text-muted">
                                                            {{ attempt.correct_answers }}/{{ attempt.total_questions }}
                                                        </small>
                                                    </div>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <small>{{ attempt.start_time|date:"M d, Y" }}<br>{{ attempt.start_time|time:"H:i" }}</small>
                                            </td>
                                            <td>
                                                {% if attempt.end_time %}
                                                    <small>{{ attempt.end_time|date:"M d, Y" }}<br>{{ attempt.end_time|time:"H:i" }}</small>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if attempt.time_taken %}
                                                    <small>{{ attempt.time_taken.total_seconds|floatformat:0 }}s</small>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if attempt.status == 'completed' %}
                                                    <a href="{% url 'attemp_quiz:quiz_result' attempt.id %}" class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-eye me-1"></i>View Result
                                                    </a>
                                                {% elif attempt.status == 'in_progress' or attempt.status == 'started' %}
                                                    <a href="{% url 'attemp_quiz:take_quiz' attempt.id %}" class="btn btn-sm btn-warning">
                                                        <i class="fas fa-play me-1"></i>Continue
                                                    </a>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Summary Statistics -->
                        <div class="row mt-4">
                            <div class="col-md-3 text-center">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h4 class="text-primary">{{ attempts.count }}</h4>
                                        <p class="text-muted mb-0">Total Attempts</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h4 class="text-success">{{ attempts|length|add:0 }}</h4>
                                        <p class="text-muted mb-0">Completed</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        {% with completed_attempts=attempts|dictsort:"status" %}
                                        {% with completed_scores=completed_attempts|dictsort:"score" %}
                                        <h4 class="text-info">
                                            {% if completed_scores %}
                                                {{ completed_scores|last.score|floatformat:1 }}%
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </h4>
                                        {% endwith %}
                                        {% endwith %}
                                        <p class="text-muted mb-0">Best Score</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h4 class="text-warning">
                                            {% with completed_attempts=attempts|dictsort:"score" %}
                                                {% if completed_attempts %}
                                                    {{ completed_attempts|dictsort:"score"|first.score|floatformat:1 }}%
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            {% endwith %}
                                        </h4>
                                        <p class="text-muted mb-0">Average Score</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Quiz Attempts</h5>
                            <p class="text-muted">You haven't attempted any quizzes yet.</p>
                            <a href="{% url 'attemp_quiz:eligible_quizzes' %}" class="btn btn-primary">
                                <i class="fas fa-play me-1"></i>
                                Browse Available Quizzes
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
